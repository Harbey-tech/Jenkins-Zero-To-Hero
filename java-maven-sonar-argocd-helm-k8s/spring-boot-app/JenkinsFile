pipeline {
  agent any

  environment {
    REGISTRY = "harbeytech" // your Docker Hub username
    IMAGE_NAME = "jenkins-end-to-end-cicd-project"
  }

  stages {

    stage('Checkout') {
      steps {
        git branch: 'main', url: 'https://github.com/Harbey-tech/JENKINS-END-TO-END-CICD-PROJECT.git'
      }
    }

    stage('Build and Test') {
      steps {
        script {
          echo "Building the project with Maven..."
          sh 'mvn clean package -DskipTests=false'
        }
      }
    }

    stage('Static Code Analysis - SonarCloud') {
      when {
        expression { return false } // change to true once you set up SonarCloud
      }
      steps {
        echo "SonarCloud analysis would run here..."
      }
    }

    stage('Build Docker Image') {
      steps {
        script {
          echo "Building Docker image..."
          sh "docker build -t ${REGISTRY}/${IMAGE_NAME}:${BUILD_NUMBER} ."
        }
      }
    }

    stage('Push Docker Image') {
      environment {
        DOCKERHUB_CREDS = credentials('docker-cred') // your Jenkins DockerHub credentials ID
      }
      steps {
        script {
          echo "Pushing Docker image..."
          sh "echo ${DOCKERHUB_CREDS_PSW} | docker login -u ${DOCKERHUB_CREDS_USR} --password-stdin"
          sh "docker push ${REGISTRY}/${IMAGE_NAME}:${BUILD_NUMBER}"
        }
      }
    }
  }

  post {
    success {
      echo "✅ Build completed successfully!"
    }
    failure {
      echo "❌ Build failed. Check the Jenkins logs."
    }
  }
}
