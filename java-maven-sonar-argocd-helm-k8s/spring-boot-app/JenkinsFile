pipeline {
  agent any

  environment {
    REGISTRY = "harbeytech"
    IMAGE_NAME = "jenkins-end-to-end-cicd-project"
  }

  stages {
    stage('Checkout') {
      steps {
        git branch: 'main', url: 'https://github.com/Harbey-tech/JENKINS-END-TO-END-CICD-PROJECT.git'
      }
    }

    stage('Diagnostics') {
      steps {
        script {
          echo "üîç Running diagnostics to inspect workspace..."
          sh '''
            echo "Current directory:" 
            pwd
            echo ""
            echo "Workspace contents:"
            ls -la
            echo ""
            echo "Checking for spring-boot-app directory:"
            if [ -d spring-boot-app ]; then
              echo "‚úÖ spring-boot-app directory exists."
            else
              echo "‚ùå spring-boot-app directory NOT found."
            fi
            echo ""
            echo "Searching for pom.xml:"
            find . -name "pom.xml"
            echo ""
            echo "Listing Docker installations:"
            docker --version || echo "Docker not found!"
            echo ""
            echo "Listing Maven version:"
            mvn -v || echo "Maven not found!"
          '''
        }
      }
    }

    stage('Build and Test') {
      steps {
        script {
          echo "üõ† Building project with Maven..."
          sh 'mvn clean package -DskipTests=false'
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        script {
          echo "üê≥ Building Docker image..."
          sh "docker build -t ${REGISTRY}/${IMAGE_NAME}:${BUILD_NUMBER} ."
        }
      }
    }

    stage('Push Docker Image') {
      environment {
        DOCKERHUB_CREDS = credentials('docker-cred')
      }
      steps {
        script {
          echo "üì§ Pushing Docker image..."
          sh "echo ${DOCKERHUB_CREDS_PSW} | docker login -u ${DOCKERHUB_CREDS_USR} --password-stdin"
          sh "docker push ${REGISTRY}/${IMAGE_NAME}:${BUILD_NUMBER}"
        }
      }
    }
  }

  post {
    success {
      echo "‚úÖ Build completed successfully!"
    }
    failure {
      echo "‚ùå Build failed. Check diagnostics above."
    }
  }
}
